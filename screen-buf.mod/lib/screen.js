const palette = [

    // === block 0 === 
    null,       // 00 -transparent
    // nord - frost and aurora
    '#bf616a', // red
    '#d08770', // orange
    '#ebcb8b', // yellow
    '#a3be8c', // green
    '#88c0d0', // cyan
    '#81a1c1', // blue
    '#5e81ac', // almost violet
    '#b48ead', // magenta
    '#d8dee9', // heavy snow
    //'#eceff4', // light snow

    // '', '', '', '', '', '', '', '', '', '',

    // =========================
    // sweetie 16
    '#2d5b69', // selenzied dark bg-2
    '#b13e53', // red
    '#ef7d57', // orange
    //'#ffcd75', // yellow
    '#fabd2f', // yellow
    '#38b764', // green
    '#257179', // teal
    '#41a6f6', // sky blue
    '#3b5dc9', // sea blue
    '#5d275d', // dark red
    '#f9f5d7', // gruvbox light0-hard
    //'#e5e9f0', // snow
    //'#f4f4f4', // sweetie whitish



    // === block ===
    '#184956', // selenized dark bg-1
    // selenized dark background
    '#ff5e56', // red
    '#fa9153', // orange
    '#efc541', // yellow
    '#83c746', // green
    '#56d8c9', // cyan
    '#4f9cfe', // blue
    '#b891f5', // violet
    '#ff81ca', // magenta
    '#fbf1c7', // gruvbox light0

    // === block ===
    '#103c48', // selenized dark bg-0
    // selenized light
    '#d2212d', // red
    '#c25d1e', // orange
    '#ad8900', // yellow
    '#489100', // green
    '#009c8f', // cyan
    '#0072d4', // blue
    '#8762c6', // violet
    '#ca4898', // magenta
    '#f2e5bc', // gruvbox light0-soft

    // gruvbox normie
    '#3b3b3b', // selenized bg-2
    '#cc241d', // red
    '#d65d0e', // orange
    '#d79921', // yellow
    '#98971a', // green
    '#689d6a', // aqua
    '#458588', // blue
    '#8888cc', // plan9 - purple
    '#b16286', // purple
    '#53676d', // selenized fg-0


    // gruvbox faded
    '#252525', // selenized bg-1
    '#9d0006', // red
    '#af3a03', // orange
    '#b57614', // yellow
    '#79740e', // green
    '#427b58', // aqua
    '#076678', // blue
    '#444488', // plan 9 - dark purple
    '#8f3f71', // purple
    '#72898f', // selenized dark dim-0


    // =========================
    // bubblegum
    '#181818', // selenized bg-0
    //'#16171a', // black
    '#7f0622', // dark red
    '#ffd100', // yellow
    '#bfff3c', // light green
    '#10d275', // green
    '#68aed4', // blue
    '#007899', // teal
    '#430067', // purple
    '#ff2674', // pink
    '#b9b9b9', // selenized fg-0

    // =========================
    // sweetie 16
    '#333c57', // nord - dark gray 
    '#cc8888', // plan 9 red
    '#cccc88', // plan 9 yellow
    '#ebdbb2', // gruvbox light1
    '#a7f070', // sweetie 16 salad green
    '#73eff7', // sweetie 16 cyan
    '#29366f', // sweetie 16 dark blue
    //'#1a1c2c', // black
    '#a580e2', // violet
    '#ff80a4', // bubblegum light pink
    '#c7f0d8', // cyan


    // pure
    '#000000', //
    '#ff0000', //
    '#ff8000', //
    '#ffff00', //
    '#00ff00', //
    '#00ffff', //
    '#0000ff', //
    '#8000ff', //
    '#ff00ff', //
    '#ffffff', //

    // pure 2
    '#404040', //
    '#800000', //
    '#804000', //
    '#808000', //
    '#008000', //
    '#008080', //
    '#000080', //
    '#400080', //
    '#800080', //
    //'#808080', //
    '#777777', // selenized black dim-0

    // shades of nokia 12
    '#884444', // plan 9 dark red
    '#744538', // n12 brown
    '#aa6d3c', // n12 orange brown
    //'#aa9d80', // light brown
    '#a89984', // gruvbox light4
    '#43523d', // n12 greenish
    '#88cccc', // plan 9 blue
    '#3c4460', // n12 blue
    '#695e70', // n12 purple
    '#884488', // plan 9 dark magenta
    '#909995', // selenized dim-0

    // =================================
    // nord - polar night
    '#3a4d53', // selenized fg-1
    '#2e3440', // nord deep night
    '#3b4252', // nord night
    '#434c5e', // nord light night
    '#4c566a', // nord dusk
    '#566c86', // nord metal gray
    // nord - snow storm
    //'#8fbcbb', // teal
    //'#94b0c2', // sweetie 16 light gray
    '#bdae93', // gruvbox light3
    '#d5c4a1', // gruvbox light2
    '#d5cdb6', // selenized bg-2
    '#ece3cc', // selenized bg-1



    // grovbox base dark
    '#312b25', // n12 dark brown
    '#1d2021', // gruvbox dark0-hard
    '#282828', // gruvbox dark0
    '#32302f', // gruvbox dark0-soft
    '#3c3836', // gruvbox dark1
    '#504945', // gruvbox dark2
    '#665c54', // gruvbox dark3
    '#7c6f64', // gruvbox dark4
    '#928374', // gruvbox gray_245
    '#adbcbc', // selenized dark fg-0


    // tester line
    '#404040',
    '#404040',
    '#404040',
    '#404040',
    '#404040',
    '#404040',
    '#404040',
    '#404040',
    '#808080',
    '#808080',


    '', '', '', '', '', '', '', '', '', '',


    // carbon copy
    '#81a1c1', // blue
    '#5e81ac', // almost violet

    '#ece3cc', // selenized bg-1
    '#f9f5d7', // gruvbox light0-hard
    '', '',
    '', '',
    '', '',

    /*
    // solarized
    '',
    '#e9362b', // red
    '#cb4b16', // orange
    '#b58900', // yellow
    '#859900', // green
    '#2aa198', // cyan
    '#268bd2', // blue
    '#6c71c4', // violet
    '#d33682', // magenta
    '',
    */

    /*
    // =====================
    '',
    // solarized base
    '#002b36',    // base 03
    '#073642',    // base 02
    '#586e75',    // base 01
    '#657b83',    // base 00
    '#839496',    // base 0
    '#93a1a1',    // base 1
    '#eee8d5',    // base 2 - pale mocca
    '#fdf6e3',    // base 3
    '',
    */

    // === block ===
    '',
    // selenized light background
    '#cc1729', // red
    '#bc5819', // orange
    '#a78300', // yellow
    '#428b00', // green
    '#00978a', // cyan
    '#006dce', // blue
    '#825dc0', // violet
    '#c44392', // magenta
    '',


    // =====================
    '',
    // selenized dark
    '#ed4a46', // red
    '#e67f43', // orange
    '#dbb32d', // yellow
    '#70b433', // green
    '#3fc5b7', // cyan
    '#368aeb', // blue
    '',
    //'#a580e2', // violet
    '#eb6eb7', // magenta
    '', //


    // gruvbox bright
    '', //
    '#fb4934', // red
    '#fe8019', // orange
    '',
    '#b8bb26', // green 
    '#8ec07c', // aqua
    '#83a598', // blue
    '#d3869b', // purple
    '', //
    '', //





    // plan 9
    '',
    '',
    '', //
    '#88cc88', // plan 9 green
    '', //
    '',
    '',
    '#cc88cc', // plan 9 magenta
    '', //


    '',
    '',
    '',
    '#888844', // plan 9 dark yellowish
    '#448844', // plan 9 dark green
    '',
    '#448888', // plan 9 dark blue
    '', 
    '',
]

const colors = {
    'clear':    null,           // 00 - transparent

    // solar
    'yellow':   '#b58900',      // solar - yellow
    'orange':   '#cb4b16',      // solar - orange
    'red':      '#e9362b',      // solar - red
    'magenta':  '#d33682',      // solar - magenta
    'violet':    '#6c71c4',     // solar - violet
    'blue':      '#268bd2',     // solar - blue
    'teal':      '#2aa198',     // solar - cyan
    'green':    '#859900',      // solar - green

    'base03':     '#002b36',    // solar - base 03
    'base02':     '#073642',    // solar - base 02
    'base01':     '#586e75',    // solar - base 01
    'base00':     '#657b83',    // solar - base 00
    'base0':      '#839496',    // solar - base 0
    'base1':      '#93a1a1',    // solar - base 1
    'base2':      '#eee8d5',    // base 2 - pale mocca
    'base3':      '#fdf6e3',    // base 3

    'ocean':     '#257179',     // darker teal
    'grass':    '#38b764',      // green
    'salad':    '#a7f070',      // salad
    'purple':   '#5d275d',
    'dark blue': '#29366f',     // dark blue
    'some blue': '#3b5dc9',     // blue
    'sky':       '#41a6f6',     // sky
    'not-cyan':  '#73eff7',     // cyan

    'metal':         '#94b0c2', // metal
    'dark-metal':    '#566c86', // dark metal
    'gray-blue':     '#333c57', // grayish blue
    'bluisn-black':  '#1a1c2c', // bluish black
    'black':         '#252527',
    'pale-yellow':   '#d1cf94', // pale yellow paper
    'brown':         '#d98148',
    'dark-orange':   '#ef7d57', // orange
    'dark-red':      '#b13e53', // red
    'bright-yellow': '#ffcd75', // yellow

    'gray':          '#808080',

    // nostalgOS retro palette
    'nos-red':      '#dc6250',
    'nos-pink':     '#deada5',
    'nos-mocha':    '#dad4c9',
    'nos-sun':      '#ffd183',
    'nos-yellow':   '#eeb24a',
    'nos-green':    '#55927f',
    'nos-teal':     '#21525a',
    'nos-gray':     '#272a32',
    'nos-blue':     '#2152a5',
    'nos-sky':      '#5a8bde',
    'nos-purple':   '#b89ce9',
    'nos-grape':    '#844790',
}

const context = {
    x: 0,
    y: 0,
}

//Object.values(colors).forEach(c => palette.push(c))

function mapColor(ci) {
    let c
    if (isNumber(ci)) {
        c = palette[ci | 0]
    } else if (isString(ci)) {
        if (ci.startsWith('#')) {
            c = ci
        } else {
            const cn = colors[ci.toLowerCase()]
            if (cn) c = ci
        }
    }
    return c
}

function drawLine(x1, y1, x2, y2, ci) {
    const c = mapColor(ci) || env.context.ink
    const RGBA = color.color2RGBA(c) // TODO optimize to have in the color table

    const dx = abs(x2 - x1),
          dy = abs(y2 - y1),
          sx = x2 >= x1? 1 : -1,
          sy = y2 >= y1? 1 : -1

    if (dy <= dx) {
        let d = (dy << 1) - dx
        let d1 = dy << 1
        let d2 = (dy - dx) << 1
        lib.gx.put(x1, y1, RGBA)

        for (let x = x1 + sx, y = y1, i = 1; i <= dx; i++, x += sx) {
            if (d > 0) {
                d += d2
                y += sy
            } else {
                d += d1
            }
            lib.gx.put(x, y, RGBA)
        }
    } else {
        let d = (dx << 1) - dy
        let d1 = dx << 1
        let d2 = (dx - dy) << 1
        lib.gx.put(x1, y1, RGBA)
        for (let x = x1, y = y1 + sy, i = 1; i <= dy; i++, y += sy) {
            if (d > 0) {
                d += d2
                x += sx
            } else {
                d += d1
            }
            lib.gx.put(x, y, RGBA)
        }
    }
}

const screen = {

    //
    // === graphics commands ===
    //
    
    screen: function(n) {
        lib.gx.enableScreen(n)
    },

    ink: function(ci) {
        const c = mapColor(ci)
        if (!c) return
        env.context.ink = c
    },

    backdrop: function(ci) {
        const c = mapColor(ci)
        if (!c) env.context.back = null
        env.context.back = c
    },

    fx: function(ifx) {
        env.context.fx = ifx
    },

    // clear the framebuffer and set the background(paper) color
    paper: function(ci) {
        if (!ci) {
            ctx.fillStyle = env.context.paper
            ctx.fillRect(0, 0, rx(1), ry(1))
        } else {
            const c = mapColor(ci)
            if (!c) return
            ctx.fillStyle = c
            ctx.fillRect(0, 0, rx(1), ry(1))
            env.context.paper = c
        }
        lib.gx.syncOut(env.context.screen)
    },

    border: function(ci) {
        const c = mapColor(ci)
        if (!c) return
        env.context.border = c
    },

    plot: function(x, y, ci) {
        x = Math.round(x)
        y = Math.round(y)
        if (x < 0 || x >= env.width || y < 0 || y >= env.height) return
        let c = env.context.ink
        if (ci !== undefined) {
            c = mapColor(ci) || '#00000000'
        }
        const RGBA = color.color2RGBA(c) // TODO optimize to have in the color table

        let i = (y * env.width + x) * 4
        lab.pdata[i++] = RGBA[0]
        lab.pdata[i++] = RGBA[1]
        lab.pdata[i++] = RGBA[2]
        lab.pdata[i  ] = RGBA[3]

        // cache coordinates in the graphical context
        context.x = x
        context.y = y
    },

    pset: function(x, y, ci) {
        let c = env.context.ink
        if (ci !== undefined) c = mapColor(ci)
        if (!c) return
        const RGBA = color.color2RGBA(c) // TODO optimize to have in the color table

        let i = (y * env.width + x) * 4
        lab.pdata[i++] = RGBA[0]
        lab.pdata[i++] = RGBA[1]
        lab.pdata[i++] = RGBA[2]
        lab.pdata[i  ] = RGBA[3]
    },

    line: function(x1, y1, x2, y2, ci) {
        let c = env.context.ink
        if (ci !== undefined) c = mapColor(ci)
        if (!c) return
        const RGBA = color.color2RGBA(c) // TODO optimize to have in the color table

        const dx = abs(x2 - x1),
              dy = abs(y2 - y1),
              sx = x2 >= x1? 1 : -1,
              sy = y2 >= y1? 1 : -1

        if (dy <= dx) {
            let d = (dy << 1) - dx
            let d1 = dy << 1
            let d2 = (dy - dx) << 1
            lib.gx.put(x1, y1, RGBA)

            for (let x = x1 + sx, y = y1, i = 1; i <= dx; i++, x += sx) {
                if (d > 0) {
                    d += d2
                    y += sy
                } else {
                    d += d1
                }
                lib.gx.put(x, y, RGBA)
            }
        } else {
            let d = (dx << 1) - dy
            let d1 = dx << 1
            let d2 = (dx - dy) << 1
            lib.gx.put(x1, y1, RGBA)
            for (let x = x1, y = y1 + sy, i = 1; i <= dy; i++, y += sy) {
                if (d > 0) {
                    d += d2
                    x += sx
                } else {
                    d += d1
                }
                lib.gx.put(x, y, RGBA)
            }
        }
    },

    line: drawLine,

    drawto: function(x, y) {
        drawLine(context.x, context.y, x, y)
        context.x = x
        context.y = y
    },

    circle: function(x, y, r, ci) {
        let c = env.context.ink
        if (ci !== undefined) c = mapColor(ci)
        if (!c) return
        const RGBA = color.color2RGBA(c) // TODO optimize to have in the color table

        lib.gx.drawCircle(x, y, r, RGBA)
    },

    box: function(x, y, w, h, ci) {
        let c = env.context.ink
        if (ci !== undefined) c = mapColor(ci)
        if (!c) return
        const RGBA = color.color2RGBA(c) // TODO optimize to have in the color table

        lib.gx.drawBox(x, y, w, h, RGBA)
    },

    color: function(faceColor, backgroundColor, borderColor) {
        if (faceColor && typeof faceColor !== 'object') {
            this.command.ink(faceColor)
        }
        if (backgroundColor && typeof backgroundColor !== 'object') {
            this.command.paper(backgroundColor)
        }
        if (borderColor && typeof borderColor !== 'object') {
            this.command.border(borderColor)
        }
    },

    iput: function(dim, x, y) {
        const W = env.context.width
        const H = env.context.height

        const d = dim.data
        const w = d[0]
        const h = d[1]
        const x2 = clamp(x + w, x, W)
        const y2 = clamp(y + h, y, H)
        const x1 = clamp(x, 0, W)
        const y1 = clamp(y, 0, H)

        const pdata = lab.pdata

        let i = 2
        for (let cy = y1; cy < y2; cy++) {
            const base = (cy * W * 4)
            for (let cx = x1; cx < x2; cx++) {
                let sh = base + cx * 4
                pdata[sh]   = d[i++]
                pdata[sh+1] = d[i++]
                pdata[sh+2] = d[i++]
                pdata[sh+3] = d[i++]
            }
        }
    },
}

// aliases
screen.background = screen.paper
screen.face = screen.ink

//
// === help ===
//
screen.screen.usage = '[number]'
screen.screen.man = 'enable the screen #'

screen.paper.usage = '[color]'
screen.paper.tags = 'classic, draw'
screen.paper.man = 'set background(paper) color'

// TODO how to split help for similar functions? Can we close a function?
screen.background.usage = '[color]'
screen.background.tags = 'classic, draw'
screen.background.man = 'set background(paper) color'

screen.border.usage = '[color]'
screen.border.tags = 'classic, draw'
screen.border.man = 'set border color'

screen.ink.usage = '[color]'
screen.ink.tags = 'classic, draw'
screen.ink.man = 'set ink color'

screen.backdrop.usage = '[color]'
screen.backdrop.tags = "text"
screen.backdrop.man = 'set character backdrop color, 0 if transparent'

screen.fx.usage = '[type]'
screen.fx.tags = "text"
screen.fx.man = 'set character effect\n    available types:'
                + '\n    0: none'
                + '\n    1: inverse blink'
                + '\n    2: blink'
                + '\n    3: underscore with the face color'
                + '\n    4: underscore with the backdrop color'
                + '\n    5: strikethrough with the face color'
                + '\n    6: strikethrough with the backdrop color'

screen.face.usage = '[color]'
screen.face.tags = "classic, text"
screen.face.man = 'set ink color'

screen.color.usage = "<face>, <background>, <border>"
screen.color.tags = "classic, draw"
screen.color.man =   "set colors"

screen.plot.usage = "[x], [y], <color>"
screen.plot.tags = "core, classic, draw"
screen.plot.man = "draw a pixel"

screen.pset.usage = "[x], [y], <color>"
screen.pset.tags = "core, classic, draw"
screen.pset.man = "low-level set of a pixel value"

screen.line.usage = "[x1], [y1], [x2], [y2], <color>"
screen.line.tags = "draw"
screen.line.man = "draw a line"

screen.drawto.usage = "[x], [y]"
screen.drawto.tags = "draw"
screen.drawto.man = "draw a line to coordinates"

screen.circle.usage = "[x], [y], [r], <color>"
screen.circle.tags = "draw"
screen.circle.man = "draw a circle"

screen.iput.usage = '[array], [x], [y]'
screen.iput.man = 'draw image data'

